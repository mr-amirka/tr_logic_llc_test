# TR Logic LLC test solution [![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://github.com/mr-amirka/tr_logic_llc_test/blob/master/LICENSE) [![Build Status](https://travis-ci.org/mr-amirka/tr_logic_llc_test.svg?branch=master)](https://travis-ci.org/mr-amirka/tr_logic_llc_test) [![codecov](https://codecov.io/gh/mr-amirka/tr_logic_llc_test/branch/master/graph/badge.svg)](https://codecov.io/gh/mr-amirka/tr_logic_llc_test)


Задание:
-------

**Реализовать простое REST API с одним единственным методом, который загружает изображения.**


Требования:
- [X] Возможность загружать несколько файлов.
- [X] Возможность принимать multipart/form-data запросы.
- [X] Возможность принимать JSON запросы с BASE64 закодированными изображениями.
- [X] Возможность загружать изображения по заданному URL (изображение размещено где-то в интернете).
- [X] Создание квадратного превью изображения размером 100px на 100px.
- [X] Наличие модульных/интеграционных тестов.

Временем и инструментом для выполнение тестового задания Вы не ограничены.
 Любые другие аспекты реализации, которые не указаны в требованиях, могут быть выполнены на Ваше усмотрение.

Следующее будет плюсом:
- [X] \(Optional) Корректное завершение приложения при получении сигнала ОС (graceful shutdown).
- [X] \(Optional) Dockerfile и docker-compose.yml, которые позволяют поднять приложение единой docker-compose up командой.
- [X] \(Optional) CI интеграция (Travis CI, Circle CI, другие).
- [X] \(Optional) Использование отдельной внешней библиотеки обработки изображений (к примеру, OpenCV) для демонстрации FFI.

Тестовое задание должно быть предоставлено в виде ссылки на публичный репозиторий (GitHub, BitBucket, GitLab),
 содержащий исходный код приложения и необходимые инструкции по сборке и запуску.


TR Logic LLC <contact@itprojects.management>

___
## Решение:

___
### Install

##### Clone Git
```sh
git clone https://github.com/mr-amirka/tr_logic_llc_test.git
cd ./tr_logic_llc_test
```


##### Install Rust, cmake, and compile OpenCV
```sh
bash ./install.sh
```

##### Run
```sh
cagro test
cargo run
```

---
### Use Docker
```sh
docker build -f ./Dockerfile-base -t tr_logic_llc/base .
docker-compose up
```


----
### API

#### 1. Загрузка изображений  

Загрузка изображений осуществляется методом POST для [/images](http://0.0.0.0:8000/images)  


##### Доступные способы загрузки изображений:  

1. Загрузка одного изображения непосредственно в бинарном формате (``` Content-Type: image/* ```);  
2. Загрузка нескольких изображений в формате multipart/form-data (``` Content-Type: multipart/form-data ```), где каждое обрабатываемое поле с изображением должно иметь имя ``` image ``` и ``` Content-Type: image/* ```;  
3. Загрузка одного изображения в JSON формате с BASE64 закодированным содержимом (``` Content-Type: application/json ```).  


Пример 1:  
```js
{
  "name": "any-image.png", //optional
  "type": "image/png",
  "content": "..." //base64 content
}
```
Пример 2:
```js
"data:image/png;base64,..." //base64 content
```

4. Загрузка нескольких изображений в JSON формате с BASE64 закодированным содержимом.  


Например:  
``` Content-Type: application/json ```  
```js
[
  {
    "type": "image/png",
    "content": "..." //base64 content
  },
  "data:image/png;base64,..." //base64 content
]
```

5. Загрузка нескольких изображений в текстовом формате с BASE64 закодированным содержимом или со сторонних ресурсов по заданному URL, разделенных переводом строки.  


Например:  
``` Content-Type: text/plain ```  
```
https://pp.userapi.com/c824700/v824700073/10fc4d/FV-rsLVCTGo.jpg
data:image/png;base64,...
data:image/jpeg;base64,...
https://pp.userapi.com/c852024/v852024453/16c16a/uYJ5mGfBBDE.jpg
```

##### Ответ на запрос возвращается в формате JSON.  

Пример ответа сервера:
```js
{
  "items": [
    {
      "Ok": {
        "original": "https://pp.userapi.com/c824700/v824700073/10fc4d/FV-rsLVCTGo.jpg",
        "name": "s/w/-/GLWQedNWoUApJ-OjfGqQ5YhQ4pXu0x0lFHCA_Hfs.jpg"
        "size": 106432
      }
    },
    {
      "Ok": {
        "original": null,
        "name": "I/Z/-/BjhYHGCebfhPoBGSEy6STwxPeH1XxmomLJ38-V0w.png"
        "size": 1416
      }
    },
    {
      "Err": {
        "type": "Unsupported"
      }
    },
    {
      "Err": {
        "type": "Invalid"
      }
    }
    /// ...
  ]
}
```


##### Проверяется валидность изображений.

При загрузке изображения проверяется валидность его формата по сигнатуре нескольких первых байтов,
и затем после получения всех данных сервер повторно проверяет валидность формата всего изображения в процессе генерации миниатюры.


##### Доступные форматы изображений:
- jpeg;  
- png;  
- bmp.  





#### 2. Получение изображения

Получение изображения осуществляется методом GET для [/images](http://0.0.0.0:8000/images)  

Шаблон запроса:
```
/images/{filename}
```

Например:
```
GET http://0.0.0.0:8000/images/I/Z/-/BjhYHGCebfhPoBGSEy6STwxPeH1XxmomLJ38-V0w.png
```


#### 3. Получение квадратного превью изображения

Получение квадратного превью изображения осуществляется методом GET для [/thumbnails](http://0.0.0.0:8000/thumbnails)  

Шаблон запроса:
```
/thumbnails/{filename}
```

Например:
```
GET http://0.0.0.0:8000/thumbnails/I/Z/-/BjhYHGCebfhPoBGSEy6STwxPeH1XxmomLJ38-V0w.png
```

#### 4. Front-end приложения

Front-end приложение для тестирования серверной части доступно по адресу: [/](http://0.0.0.0:8000/)  
К Front-end приложению относятся также ресурсы:
- [/assets/app.css](http://0.0.0.0:8000/assets/app.css);
- [/assets/app.js](http://0.0.0.0:8000/assets/app.js);
- [/assets/environment.js](http://0.0.0.0:8000/assets/environment.js).

Методы для получения частей Front-end приложения отдают содержимое непосредственно из памяти, ибо это более целесообразно.

----
### Конфигурация приложения в ./data/config.toml

В конфигурации можно настроить:
-  директорию для хранения изображений (IMAGES_DIR = "./data/images/");  
-  директорию для хранения первью изображений (THUMBNAILS_DIR = "./data/thumbnails/");  
-  директорию для временных файлов (TEMP_DIR = "./data/tmp/");  
-  порт приложения (PORT = 8000);  
-  ширину, генерируемых превью изображений (THUMBNAILS_WIDTH = 100);  
-  высоту, генерируемых превью изображений (THUMBNAILS_HEIGHT = 100);   
-  максимальный размер принимаемых файлов (FILE_MAX_SIZE = 10485760);  
-  максимальный размер принимаемых данных в JSON формате (JSON_MAX_SIZE = 10485760);  
-  максимальный размер принимаемых данных в текстовом формате (TEXT_MAX_SIZE = 10485760).  

----
### Примечания

Для решения задачи перепробовал несколько фреймворков (Hyper, Iron, Nickel, Rocket) и даже пытался имплементировать с нуля,
но в итоге остановился на Actix-web, ибо он позволяет обрабатывать запросы и стримово, и асинхронно, и имеет множество удобных инструментов.  


При решении задания, изначально планировал записывать принимаемые файлы стримово сразу на диск, но так как для генерации превью, всё равно,  необходимо держать содержимое всего изображения в памяти, от этого замысла пришлось отклониться.  


Приложение обрабатывает кросс-доменные запросы (CORS).


Файлы с тестами размещаются непосредственно в директориях тех модулей приложения, которые тестируются.  


Изображения по умолчанию сохраняются в директорию ``` ./data/images/ ```.  

Миниатюры изображений по умолчанию сохраняются в директорию ``` ./data/thumbnails/ ```.  

Директория Front-end приложения ``` ./data/public/ ```.  

Путь к файлу конфигурации: ``` ./data/config.toml ```.


С целью сокращение длины имени загружаемого файла, его имя из HEX формата конвертируется в url-safe base64.  


С целью облегчения чтения списка файлов каталога, когда их может быть очень много,
для файлов автоматически генерируются поддиректории на основе трех первых символов имени файла.  

Например:  
```
i2D7SQIQYCYlr9t4JMXgFw.png -> i/2/D/7SQIQYCYlr9t4JMXgFw.png
```

----
### Долгая сборка, в связи с использованием библиотеки обработки изображений OpenCV

Сборка проекта может занимать до 2-х часов и 8.5 Гб дискового пространства!!!  


В Travis CI из-за превышения лимита по времени проект в исходном виде не собирается,
поэтому я залил уже скомпилированную на своей платформе библиотеку OpenCV 4.1.1 на Яндекс.Диск и библиотека скачивается по публичной ссылке с помощью команды ``` wget $(ydlink -l https://yadi.sk/d/vZ-3Cx8mfnn_lw) -O ./OpenCV.tar ```
